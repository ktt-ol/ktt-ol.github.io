<!doctype html><html prefix="og: https://ogp.me/ns#" data-bs-theme=dark lang=de><head><meta charset=utf-8><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="Kreativität trifft Technik e.V." property=og:site_name><meta content=de_DE property=og:locale><meta content=de_DE property=og:locale:alternate><meta content=en_US property=og:locale:alternate><meta content=https://ktt-ol.github.io/blog/2016/tiny-ws2812-controller property=og:url><meta content=sre name=author><meta content=article property=og:type><script type=application/ld+json>
        {
            "@context": "https://schema.org/",
            "@type": "ImageObject",
            "contentUrl": "https://ktt-ol.github.io/media/blog/2016/tiny-ws2812-controller/thumbnail.jpg",
        "license": "https://creativecommons.org/licenses/by-sa/4.0/",
        "acquireLicensePage": "https://creativecommons.org/licenses/by-sa/4.0/",
        "creditText": "Tiny WS2812 Controller",
        "creator": {
            "@type": "Person",
            "name": "sre",
            "url": "https://mainframe.io"
        },
        "copyrightNotice": "sre"
    }
    </script><meta content=https://ktt-ol.github.io/media/blog/2016/tiny-ws2812-controller/thumbnail.jpg property=og:image><meta content=https://ktt-ol.github.io/media/blog/2016/tiny-ws2812-controller/thumbnail.jpg property=og:image:secure_url><meta content=image/jpg property=og:image:type><meta content=205 property=og:image:width><meta content=180 property=og:image:height><meta content="Tiny WS2812 Controller" property=og:image:alt><meta content=summary_large_image property=twitter:card><meta content=sre property=twitter:site><meta content=sre property=twitter:creator><meta content=https://ktt-ol.github.io/media/blog/2016/tiny-ws2812-controller/thumbnail.jpg property=twitter:image><meta content="Tiny WS2812 Controller" property=twitter:title><meta content=205 property=twitter:image:width><meta content=image/jpg property=twitter:image:type><meta content=180 property=twitter:image:height><title>Tiny WS2812 Controller | Kreativität trifft Technik e.V.</title><meta content="Tiny WS2812 Controller | Kreativität trifft Technik e.V." property=og:title><meta content="Website des Kreativität trifft Technik e.V." property=og:description><meta content="Website des Kreativität trifft Technik e.V." name=description><script type=application/ld+json>
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "image": "https://www.ktt-ol.de/media/img/logo-ktt.png",
            "url": "https://www.ktt-ol.de",
            "sameAs": [
                "https://mainframe.io",
                "https://kreativitaet-trifft-technik.de",
                "https://kreativität-trifft-technik.de"
            ],
            "logo": "https://www.ktt-ol.de/media/img/logo-ktt.png",
            "name": "Kreativität trifft Technik e.V.",
            "description": "Kreativität trifft Technik e.V. - Hackspace Oldenburg",
            "email": "vorstand@ktt-ol.de",
            "telephone": "+49441-559 700 32",
            "address": {
                "@type": "PostalAddress",
                "streetAddress": "Bahnhofsplatz 10",
                "addressLocality": "Oldenburg",
                "addressCountry": "DE",
                "addressRegion": "Innenstadt",
                "postalCode": "26122"
            },
            "vatID": "",
            "iso6523Code": ""
        }
    </script><link href=https://ktt-ol.github.io/css/site.css rel=stylesheet><link href=https://ktt-ol.github.io/rss.xml rel=alternate title=RSS type=application/rss+xml><link href=https://ktt-ol.github.io/atom.xml rel=alternate title=RSS type=application/rss+xml><body class="vh-100 m-0 p-0"><div class="container-lg h-100 px-lg-0 px-4 d-flex flex-column text-white"><header class="row my-2" id=navbar><div class=col><nav class="navbar navbar-expand-lg bg-body-secondary rounded"><div class=container-fluid><a class=navbar-brand href=https://ktt-ol.github.io/ style=padding-top:10px;padding-bottom:10px> <img alt="Mainframe Logo" id=img-logo-mainframe src=https://ktt-ol.github.io/media/img/logo-mainframe.svg style=height:28px> </a><button aria-label="Toggle navigation" aria-expanded=false class=navbar-toggler data-bs-target=#navbarNav data-bs-toggle=collapse type=button><span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNav><ul class="navbar-nav me-auto"><li class="nav-item dropdown"><a class="text-white text-decoration-none d-block py-2 pe-3 dropdown-toggle" aria-expanded=false data-bs-toggle=dropdown href=# role=button> Der Verein </a> <ul class=dropdown-menu><li><a class=dropdown-item href=/about/about/> Über uns </a><li><a class=dropdown-item href=/about/membership/> Mitgliedschaft </a><li><a class=dropdown-item href=/about/support/> Unterstützen </a><li><a class=dropdown-item href=/about/communication/> Kommunikation </a><li><a class=dropdown-item href=/about/in-the-press/> Pressespiegel </a><li><a class=dropdown-item href=/about/history/> Vereinsgeschichte </a></ul><li class="nav-item dropdown"><a class="text-white text-decoration-none d-block py-2 pe-3 dropdown-toggle" aria-expanded=false data-bs-toggle=dropdown href=# role=button> Räume </a> <ul class=dropdown-menu><li><a class=dropdown-item href=/spacewalk/overview/> Übersicht </a><li><a class=dropdown-item href=/spacewalk/lasercutter/> Lasercutter </a><li><a class=dropdown-item href=/spacewalk/elektronik-werkstatt/> Elektronik-Werkstatt </a><li><a class=dropdown-item href=/spacewalk/3d-lab/> 3D-Labor </a><li><a class=dropdown-item href=/spacewalk/schnittstelle/> Schnittstelle (Textilien) </a><li><a class=dropdown-item href=/spacewalk/radstelle/> Radstelle (Fahrrad) </a><li><a class=dropdown-item href=/spacewalk/holz-werkstatt/> Holz-Werkstatt </a><li><a class=dropdown-item href=/spacewalk/metall-werkstatt/> Metall-Werkstatt </a><li><a class=dropdown-item href=/spacewalk/foto-lab/> Foto-Labor </a><li><a class=dropdown-item href=/spacewalk/rem/> REM </a><li><a class=dropdown-item href=/spacewalk/kueche/> Küche </a><li><a class=dropdown-item href=/spacewalk/lounge/> Conference, Freifläche, Lounge </a></ul><li class="nav-item dropdown"><a class="text-white text-decoration-none d-block py-2 pe-3 dropdown-toggle" aria-expanded=false data-bs-toggle=dropdown href=# role=button> Bilder </a> <ul class=dropdown-menu><li><a class=dropdown-item href=/images/panorama/> Virtual Tour </a><li><a class=dropdown-item href=/images/albums/> Fotoalben </a><li><a class=dropdown-item href=/images/ifs/> Images From Space </a></ul><li class=nav-item><a class="text-white text-decoration-none d-block py-2 pe-3" aria-expanded=false href=https://ktt-ol.github.io/blog/ role=button> Blog </a><li class=nav-item><a class="text-white text-decoration-none d-block py-2 pe-3" aria-expanded=false href=https://ktt-ol.github.io/calendar/ role=button> Termine </a><li class=nav-item><a class="text-white text-decoration-none d-block py-2 pe-3" aria-expanded=false href=https://ktt-ol.github.io/contact/ role=button> Kontakt </a><li class=nav-item><a class="text-white text-decoration-none d-block py-2 pe-3" aria-expanded=false href=https://ktt-ol.github.io/contact/#anreise role=button> Anreise </a></ul><ul class="navbar-nav navbar-right"><li class="nav-item dropdown"><a class="text-white text-decoration-none d-block py-2 pe-3 dropdown-toggle" aria-expanded=false data-bs-toggle=dropdown href=# role=button>  <svg class="bi bi-translate" viewbox="0 0 16 16" fill=currentColor height=16 width=16 xmlns=http://www.w3.org/2000/svg><path d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286zm1.634-.736L5.5 3.956h-.049l-.679 2.022z"></path><path d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zm7.138 9.995q.289.451.63.846c-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.047h.765c-.318.844-.74 1.546-1.272 2.13a6 6 0 0 1-.415-.492 2 2 0 0 1-.94.31"></path></svg> </a> <ul class=dropdown-menu><li><a class=dropdown-item href=/blog/2016/tiny-ws2812-controller> <img alt="german flag" class=me-1 src=https://ktt-ol.github.io/media/img/lang/de.png> Deutsch </a><li><a class=dropdown-item href=/en/blog/2016/tiny-ws2812-controller> <img alt="english flag" class=me-1 src=https://ktt-ol.github.io/media/img/lang/en.png> Englisch </a></ul></ul></div></div></nav></div></header><main class=row id=content><div class=col-lg-9><h1 class="d-flex justify-content-between">Tiny WS2812 Controller <span class=text-end> <a class="badge text-bg-light" rel="nofollow noreferrer noopener" href=https://github.com/ktt-ol/access-control-system/tree/master/tiny-led-firmware target=_blank> Repository </a> </span></h1><div class=main-content><p>For our access control system we <del>needed</del> wanted a few multi-colored status LEDs. Nowadays that basically means, that one gets a few ws2812b LEDs, since they are quite cheap and already provide a serial interface. Unfortunately most microcontrollers including the Raspberry Pi have no hardware accelerated interface for their protocol. For our access control system we thus use an ATtiny85 to translate from the ws2812 protocol to a more common serial protocol: I²C.<p>Below you can see how the ATtiny85 is supposed to be wired. Basically it needs power supply, the I²C interface (SDA, SCL) and the input pin of the first ws2812b LED must be connected to the pin labeled WS2812b. There is also a mode pin, that should be connected to some GPIO of the system controlling the ATtiny85. More on that later.<p><img alt="Hardware Connection" decoding=async loading=lazy src=/media/blog/2016/tiny-ws2812-controller/attiny-connections.svg><p>The ATtiny85 firmware consists of 3 parts: A driver for the ws2812b LEDs, a driver for the I²C interface and some glue-code. Let’s have a look at each part.<h2>WS2812b driver</h2><p>Like most microcontrollers, the ATtiny does not have hardware support for the ws2812 protocol. That means we need to generate it ourself by bit-banging one of its I/O pins. Since we did not connect any crystal to our ATtiny to keep the circuit simple, we use it with the internally generated 8MHz clock signal. So one instruction is supposed to be roughly 125ns. By studying the ws2812b timing diagram below, you can see, that we must be able to switch the pin at least within 350ns. As you can see the timing may be possible, but while we are updating the LEDs it’s impossible to do anything else.<p><img alt="WS2812b timings" decoding=async loading=lazy src=/media/blog/2016/tiny-ws2812-controller/ws2812b-timings.svg><p>The driver itself solves the timing issues by disabling interrupts, since any ever so short interruption will break the ws2812b timing. Then it loops over a supplied array of LED values. There it loops over the bits of each byte and based upon its value it either starts with a long high-sequence or a short high-sequence followed by the matching low-sequence. All of that is done in inline assembly to avoid the compiler doing optimizations breaking the timing.<p>In theory it would be possible to handle interrupts during the ws2812 update, if we used a timer instead of counting instructions for the precise timing. But our interrupt service routine would have to be finished within 1 or 2 instructions, since we must satisfy the 350ns timing. Obviously that’s not helping much.<h2 id=-1>I²C driver</h2><p>Fortunately the ATtiny85 does have hardware support for the I²C protocol making things a bit easier on this side. The hardware block capable of I²C (master and slave) support inside of the ATtiny85 is named Universal Serial Interface AKA <b>USI</b>. I²C is a bus-protocol, which usually has one master and multiple slave devices connected via two wires (not counting ground) named SDA and SCL.<p>The communication is always started from the master using a start-condition and stopped by a matching stop-condition. After being initialized the USI module will generate a interrupt, if it sees a start or stop condition on the bus, so that it can be handled by our I²C driver.<p>Then there is a second interrupt for all other i2c related events. Let’s ignore most of them here and just have a look how the data is exchanged. We basically get an event “data received” for each received byte and “data requested” for each byte, that should be send. The byte, that should be sent is simple written to a register of the USI block. Similarly reading the byte when the data received interrupts comes in, we get the byte written to the bus. All bit-level stuff is handled by the hardware.<p>Our I²C driver also takes care of checking the address (while it receives the data destined for other devices it will ignore any ongoing communication, that was not started with its own address as recipient) and implementing an eeprom style interface.<p>The base idea of our eeprom style interface is, that we receive colour-information from the I2C master by receiving a single byte for the LED number and 4 bytes with colour data. From a bus-level point of view this is exactly the same as an eeprom with 8-bit address size and 32-bit value size. For example if you want to set the 11th LED to white you would send the following via I²C: <code>&LTdevice-addr> 0x0a 0xff 0xff 0xff 0x00</code>. There will be more information about the additional byte in a later section of this documentation. Once the I²C driver received all 4 bytes it will call i2c_recv(led, data) in the glue code.<h2 id=-2>Glue code</h2><p>The glue-code combines the I²C driver with the ws2812b driver to something useful. For this task it stores all information received from the I²C driver into an array for the LEDs. Similarly it has a second array, which contains the LED colour information for the ws2812b driver. In theory the same array could be used for both implementations, but the split-architecture allows us to implement some fancy features in our glue-code. Unfortunately it also means, that we need quite a bit of memory (4 bytes for i2c data + 3 bytes for ws2812b data = 7 byte). With the ATtiny85 only having 512 byte of memory that means we can talk to a max. of about 60-70 LEDs.<p>Now let’s have a look at the 4th byte sent via the I²C interface. Appart from directly setting a LED color, our ATtiny85 should also be able to blink LEDs and fade to some other color. This is encoded in the fourth byte. It’s upper two bits (7&8) can be used to let the ATtiny85 know, what we want to do with the LED:<ul><li>00 = set color directly<li>01 = fade to color<li>10 = blink (on/off in specified color)<li>11 = glow (slowly decrease brightness by 25% and then increase again)</ul><p>The remaining 6 bit are a time value, which is multiplied by 31.25ms (32Hz base). For fade mode it describes how long it the (linear) fading should take. For blink and glow mode it describes how long a half period (dark → bright / bright → dark) should take. This means the max. encodable timing is 2 seconds.<h2 id=-3>Mode pin</h2><p>As described in the ws2812b section, the update requires disabled interrupts. Updating 50 LEDs requires roughly 62.5us. Disabling the interrupts for such a long time results in problems with the I²C bus. Thus the USI module must be disabled while we update the LEDs (or interrupts must be enabled resulting in broken LED update if there is I²C traffic and thus random blinking).<p>We worked around the issue by introducing another pin to choose between I²C mode and LED update mode. In I²C mode (mode pin = high) the LEDs are not updated and the timer engine for the fading is stopped (important to make the LEDs blink synchronously). In LED mode (mode pin = low) on the other hand the I²C interface is disabled.<h2 id=-4>Example</h2><p>Once the firmware is flashed and the hardware wiring is done you can now control your LEDs using the following interface:<pre class=language-txt data-lang=txt style=color:#c0c5ce;background-color:#2b303b><code class=language-txt data-lang=txt><span>device_addr = 0x23;
</span><span>mode_blink = 0x2 &amplt;&amplt; 6;
</span><span>gpio_set(mode_pin, 1); // send ATtiny85 into i2c mode
</span><span>usleep(1000); // wait until ATtiny85 reached i2c mode
</span><span>i2c_send(device_addr, 0x00, 0x80, 0x00, 0x00, 0x00); // LED0 = red
</span><span>i2c_send(device_addr, 0x01, 0x00, 0x80, 0x00, 0x00); // LED1 = green
</span><span>i2c_send(device_addr, 0x02, 0x00, 0x00, 0x80, 0x00); // LED2 = blue
</span><span>i2c_send(device_addr, 0x03, 0x30, 0x00, 0x20, mode_blink | 8); // LED3 = blink purple @ 2Hz
</span><span>io_set(mode_pin, 0); // send ATtiny85 into led mode
</span></code></pre></div></div><div class=col-lg-3><div class="mb-auto d-flex flex-column"><div class="d-flex flex-column"><h3><a class=ms-2 href=//status.mainframe.io> Status </a></h3><div class=px-2 id=space-status style=font-size:.9em><a class="d-flex p-0 flex-column text-decoration-none btn btn-white rounded-0 text-dark d-none border-bottom border-black" href=//status.mainframe.io id=status-template role=button> <div class="text-start ps-1 fw-bold lh-sm" id=status-name-template>Template:</div> <div class="text-end pe-1 lh-sm" id=status-text-unknown-template>???</div> <div class="text-end pe-1 lh-sm d-none" id=status-text-closed-template>Geschlossen</div> <div class="text-end pe-1 lh-sm d-none" id=status-text-closing-template>Schließt bald</div> <div class="text-end pe-1 lh-sm d-none" id=status-text-open-template>Geöffnet</div> <div class="text-end pe-1 lh-sm d-none" id=status-text-member-template>Geschlossen (Member Only)</div> <div class="text-end pe-1 lh-sm d-none" id=status-text-keyholder-template>Geschlossen (Keyholder Only)</div> </a></div></div><div class="d-flex mt-2 flex-column"><h3><a class=ms-2 href=https://ktt-ol.github.io/calendar/> Termine </a></h3><div class=px-2 style=font-size:.9em></div></div></div></div></main><footer class="border-top pt-2 mt-5 row" id=footer><div class=col><p style=text-align:center>© 2025 <a href=https://ktt-ol.github.io>Kreativität trifft Technik</a> | License: <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC-BY-SA 4.0</a> | <a href=https://ktt-ol.github.io/impressum/>Impressum</a></div></footer></div><script async integrity=sha384-1G/Ktf1eAP9M5l65w5viov46isK3CQ2f1pML7ZTSpgeAK0sz2zkDxQUwmixq1jrU src=https://ktt-ol.github.io/js/site.js type=module></script><script async integrity=sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q src=https://ktt-ol.github.io/js/bootstrap.bundle.min.js type=module></script><script>const ROOMS = [{"name":"spaceOpen","title":{"de":"Hackspace","en":"Hackspace"}},{"name":"machining","title":{"de":"Zerspanung","en":"Machining"}},{"name":"woodworking","title":{"de":"Holzwerkstatt","en":"Woodworking"}},{"name":"lab3dOpen","title":{"de":"3D Lab","en":"3D Lab"}},{"name":"radstelleOpen","title":{"de":"Radstelle","en":"Cycling"}}];</script>